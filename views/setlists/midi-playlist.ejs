<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0"><%= setlist.title %></h2>
                <a href="/setlists/<%= setlist.id %>" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Setlist
                </a>
            </div>
        </div>
    </div>

<style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .song-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .song-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .song-item.active {
            border-left: 4px solid #28a745;
            background-color: #f8fff9;
        }
        .set-badge {
            background-color: #6c757d;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .midi-player-container {
            position: sticky;
            top: 1rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .playlist-controls {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .view-toggle .btn {
            margin-right: 0.5rem;
        }
        .view-toggle .btn.active {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* Dark mode styles */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e9ecef;
            }
            .song-item {
                background-color: #2d3748;
                color: #e9ecef;
            }
            .song-item.active {
                background-color: #22543d;
            }
            .midi-player-container {
                background-color: #2d3748;
                border: 1px solid #4a5568;
            }
            .playlist-controls {
                background-color: #2d3748;
                border: 1px solid #4a5568;
            }
        }
    </style>

    <div class="container">
        <% if (midiLinks && midiLinks.length > 0) { %>
            <div class="view-toggle text-center">
                <button class="btn btn-outline-success active" onclick="showPlayerView()">
                    <i class="bi bi-play-circle"></i> Player View
                </button>
                <button class="btn btn-outline-success" onclick="showListView()">
                    <i class="bi bi-list-ul"></i> List View
                </button>
            </div>

            <div class="row">
                <!-- Player View -->
                <div class="col-12" id="playerView">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="playlist-controls">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="bi bi-music-note-beamed"></i> MIDI Playlist</h4>
                                    <div>
                                        <button id="playPauseBtn" class="btn btn-success" onclick="togglePlayPause()">
                                            <i class="bi bi-play-fill"></i> Play
                                        </button>
                                        <button id="nextBtn" class="btn btn-outline-success" onclick="playNext()">
                                            <i class="bi bi-skip-forward"></i> Next
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="midi-player-container">
                                    <h6>Now Playing</h6>
                                    <div id="currentTrack" class="mb-3">
                                        <div class="fw-bold">Select a track to begin</div>
                                    </div>
                                    
                                    <!-- MIDI Player -->
                                    <div id="midiPlayerContainer">
                                        <div class="text-center text-muted">
                                            <i class="bi bi-music-note-beamed fs-1"></i>
                                            <p>No track selected</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between small text-muted mb-1">
                                            <span id="currentTime">0:00</span>
                                            <span id="totalTime">0:00</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="midi-player-container">
                                <h6>Playlist</h6>
                                <div class="list-group">
                                    <% midiLinks.forEach((link, index) => { %>
                                        <button class="list-group-item list-group-item-action d-flex align-items-center" 
                                                onclick="playTrackInPlayer('<%= link.url %>', '<%= link.songTitle.replace(/'/g, "\\'") %>', '<%= (link.artist || '').replace(/'/g, "\\'") %>', <%= index %>)"
                                                id="track-<%= index %>">
                                            <span class="badge bg-secondary me-2"><%= index + 1 %></span>
                                            <div class="text-start">
                                                <div class="fw-bold"><%= link.songTitle %></div>
                                                <% if (link.artist) { %>
                                                    <div class="small text-muted"><%= link.artist %></div>
                                                <% } %>
                                                <div class="small text-muted"><%= link.set %></div>
                                            </div>
                                        </button>
                                    <% }) %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- List View -->
                <div class="col-12" id="listView" style="display: none;">
                    <div class="row">
                        <% midiLinks.forEach((link, index) => { %>
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="song-item" onclick="playTrackInPlayer('<%= link.url %>', '<%= link.songTitle.replace(/'/g, "\\'") %>', '<%= (link.artist || '').replace(/'/g, "\\'") %>', <%= index %>)">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi bi-music-note-beamed fs-3 text-success"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold"><%= link.songTitle %></div>
                                            <% if (link.artist) { %>
                                                <div class="small text-muted"><%= link.artist %></div>
                                            <% } %>
                                            <div class="small">
                                                <span class="set-badge"><%= link.set %></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <i class="bi bi-music-note-beamed fs-1 text-muted"></i>
                <h3 class="text-muted mt-3">No MIDI Files Available</h3>
                <p class="text-muted">This setlist doesn't have any MIDI files associated with its songs.</p>
                <a href="/setlists/<%= setlist.id %>" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Setlist
                </a>
            </div>
        <% } %>
    </div>
</div>

<script>
    let currentTrackIndex = -1;
    let isPlaying = false;
    let currentPlayer = null;
    const midiLinks = <%- JSON.stringify(midiLinks) %>;

    function showPlayerView() {
        document.getElementById('playerView').style.display = 'block';
        document.getElementById('listView').style.display = 'none';
        document.querySelector('.view-toggle .btn:nth-child(1)').classList.add('active');
        document.querySelector('.view-toggle .btn:nth-child(2)').classList.remove('active');
    }

    function showListView() {
        document.getElementById('playerView').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        document.querySelector('.view-toggle .btn:nth-child(1)').classList.remove('active');
        document.querySelector('.view-toggle .btn:nth-child(2)').classList.add('active');
    }

    function playTrackInPlayer(url, title, artist, index) {
        currentTrackIndex = index;
        
        // Update current track display
        document.getElementById('currentTrack').innerHTML = `
            <div class="fw-bold">${title}</div>
            ${artist ? `<div class="small text-muted">${artist}</div>` : ''}
        `;

        // Update playlist highlighting
        document.querySelectorAll('.list-group-item').forEach((item, i) => {
            item.classList.remove('active');
            if (i === index) {
                item.classList.add('active');
            }
        });

        // Clear previous player
        const container = document.getElementById('midiPlayerContainer');
        container.innerHTML = `
            <midi-player 
                src="${url}" 
                sound-font
                visualizer="#myVisualizer">
            </midi-player>
            <midi-visualizer 
                type="piano-roll" 
                id="myVisualizer" 
                src="${url}">
            </midi-visualizer>
        `;

        // Auto-play if this is the first track or if auto-play is enabled
        if (currentTrackIndex === 0) {
            setTimeout(() => {
                const player = container.querySelector('midi-player');
                if (player) {
                    player.start();
                    updatePlayPauseButton(true);
                    isPlaying = true;
                }
            }, 500);
        }
    }

    function togglePlayPause() {
        if (currentTrackIndex === -1) {
            // If no track selected, play first track
            if (midiLinks.length > 0) {
                playTrackInPlayer(midiLinks[0].url, midiLinks[0].songTitle, midiLinks[0].artist, 0);
                setTimeout(() => {
                    const player = document.getElementById('midiPlayerContainer').querySelector('midi-player');
                    if (player) {
                        player.start();
                        updatePlayPauseButton(true);
                        isPlaying = true;
                    }
                }, 500);
            }
            return;
        }

        const player = document.getElementById('midiPlayerContainer').querySelector('midi-player');
        if (player) {
            if (isPlaying) {
                player.stop();
                updatePlayPauseButton(false);
                isPlaying = false;
            } else {
                player.start();
                updatePlayPauseButton(true);
                isPlaying = true;
            }
        }
    }

    function playNext() {
        if (currentTrackIndex < midiLinks.length - 1) {
            const nextIndex = currentTrackIndex + 1;
            const nextTrack = midiLinks[nextIndex];
            playTrackInPlayer(nextTrack.url, nextTrack.songTitle, nextTrack.artist, nextIndex);
            
            // Auto-play next track
            setTimeout(() => {
                const player = document.getElementById('midiPlayerContainer').querySelector('midi-player');
                if (player) {
                    player.start();
                    updatePlayPauseButton(true);
                    isPlaying = true;
                }
            }, 500);
        }
    }

    function updatePlayPauseButton(playing) {
        const btn = document.getElementById('playPauseBtn');
        if (playing) {
            btn.innerHTML = '<i class="bi bi-pause-fill"></i> Pause';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
        } else {
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Play';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');
        }
    }

    // Auto-play first track when page loads
    document.addEventListener('DOMContentLoaded', function() {
        if (midiLinks.length > 0) {
            // Small delay to ensure MIDI player is loaded
            setTimeout(() => {
                playTrackInPlayer(midiLinks[0].url, midiLinks[0].songTitle, midiLinks[0].artist, 0);
                setTimeout(() => {
                    const player = document.getElementById('midiPlayerContainer').querySelector('midi-player');
                    if (player) {
                        player.start();
                        updatePlayPauseButton(true);
                        isPlaying = true;
                    }
                }, 1000);
            }, 500);
        }
    });
</script>
