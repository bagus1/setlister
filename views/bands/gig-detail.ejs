<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-end align-items-center gap-2">
            <a href="/bands/<%= band.id %>" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Band
            </a>
            <a href="/bands/<%= band.id %>/gigs" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Gigs
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column: Gig Details -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-calendar-event"></i> <%= gig.name %>
                </h4>
                <small class="text-muted">
                    <%= new Date(gig.gigDate).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) %>
                </small>
            </div>
            <div class="card-body">
                <!-- Venue Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="bi bi-building"></i> Venue</h6>
                        <div class="ms-3">
                            <strong><%= gig.venue.name %></strong>
                            <% if (gig.venue.venueType) { %>
                                <span class="badge bg-secondary ms-2"><%= gig.venue.venueType.name %></span>
                            <% } %>
                            <% if (gig.venue.address) { %>
                                <div class="text-muted small">
                                    <%= gig.venue.address %>
                                    <% if (gig.venue.city && gig.venue.state) { %>
                                        <br><%= gig.venue.city %>, <%= gig.venue.state %>
                                        <% if (gig.venue.zipCode) { %> <%= gig.venue.zipCode %><% } %>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-currency-dollar"></i> Payment</h6>
                        <div class="ms-3">
                            <% if (gig.fee) { %>
                                <strong>$<%= gig.fee.toLocaleString() %></strong>
                            <% } else { %>
                                <span class="text-muted">Not specified</span>
                            <% } %>
                        </div>
                    </div>
                </div>

                <!-- Schedule Information -->
                <div class="mb-4">
                    <h6><i class="bi bi-clock"></i> Schedule</h6>
                    <div class="row ms-2">
                        <% if (gig.loadInTime) { %>
                            <div class="col-md-3 mb-2">
                                <div class="small text-muted">Load In</div>
                                <div><i class="bi bi-truck text-warning"></i> <%= new Date(gig.loadInTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                            </div>
                        <% } %>
                        <% if (gig.soundCheckTime) { %>
                            <div class="col-md-3 mb-2">
                                <div class="small text-muted">Sound Check</div>
                                <div><i class="bi bi-volume-up text-info"></i> <%= new Date(gig.soundCheckTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                            </div>
                        <% } %>
                        <% if (gig.startTime) { %>
                            <div class="col-md-3 mb-2">
                                <div class="small text-muted">Start Time</div>
                                <div><i class="bi bi-play-circle text-success"></i> <%= new Date(gig.startTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                            </div>
                        <% } %>
                        <% if (gig.endTime) { %>
                            <div class="col-md-3 mb-2">
                                <div class="small text-muted">End Time</div>
                                <div><i class="bi bi-stop-circle text-danger"></i> <%= new Date(gig.endTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></div>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Gig Status -->
                <div class="mb-4">
                    <h6><i class="bi bi-check-circle"></i> Status</h6>
                    <div class="ms-3">
                        <span class="badge bg-<%= getGigStatusColor(gig.status) %> fs-6">
                            <%= gig.status.replace('_', ' ') %>
                        </span>
                    </div>
                </div>

                <!-- Links -->
                <% if (gig.ticketLink || gig.facebookEventLink) { %>
                    <div class="mb-4">
                        <h6><i class="bi bi-link-45deg"></i> Links</h6>
                        <div class="ms-3">
                            <% if (gig.ticketLink) { %>
                                <div class="mb-2">
                                    <a href="<%= gig.ticketLink %>" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-ticket"></i> Buy Tickets
                                    </a>
                                </div>
                            <% } %>
                            <% if (gig.facebookEventLink) { %>
                                <div class="mb-2">
                                    <a href="<%= gig.facebookEventLink %>" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-facebook"></i> Facebook Event
                                    </a>
                                </div>
                            <% } %>
                        </div>
                    </div>
                <% } %>

                <!-- Notes -->
                <% if (gig.notes) { %>
                    <div class="mb-4">
                        <h6><i class="bi bi-sticky"></i> Notes</h6>
                        <div class="ms-3">
                            <div class="bg-light p-3 rounded">
                                <%= gig.notes %>
                            </div>
                        </div>
                    </div>
                <% } %>

                <!-- Quick Actions -->
                <div class="mt-4">
                    <h6><i class="bi bi-lightning"></i> Quick Actions</h6>
                    <div class="ms-3">
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Edit and Delete buttons -->
                            <div class="btn-group" role="group">
                                <a href="/bands/<%= band.id %>/gigs/<%= gig.id %>/edit" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-pencil"></i> Edit Gig
                                </a>
                                <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteGigModal">
                                    <i class="bi bi-trash"></i> Delete Gig
                                </button>
                            </div>
                            
                            <!-- Contact venue dropdown -->
                            <% if (gig.venue.contacts && gig.venue.contacts.length > 0) { %>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-chat"></i> Contact Venue
                                    </button>
                                    <ul class="dropdown-menu">
                                        <% gig.venue.contacts.forEach(contact => { %>
                                            <li>
                                                <% if (contact.url && contact.url !== 'mailto:{contact}') { %>
                                                    <a class="dropdown-item" href="<%= contact.url.replace('{contact}', contact.value) %>" target="_blank">
                                                        <i class="bi bi-<%= getContactIcon(contact.contactType.name) %>"></i> 
                                                        <%= contact.contactType.displayName %>
                                                    </a>
                                                <% } else { %>
                                                    <span class="dropdown-item">
                                                        <i class="bi bi-<%= getContactIcon(contact.contactType.name) %>"></i> 
                                                        <%= contact.value %>
                                                    </span>
                                                <% } %>
                                            </li>
                                        <% }); %>
                                    </ul>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Venue Details & Recent Activity -->
    <div class="col-lg-4">
        <!-- Venue Contact Information -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-telephone"></i> Venue Contacts
                </h6>
            </div>
            <div class="card-body">
                <% if (gig.venue.contacts && gig.venue.contacts.length > 0) { %>
                    <% gig.venue.contacts.forEach(contact => { %>
                        <div class="mb-2">
                            <div class="small text-muted"><%= contact.contactType.displayName %></div>
                            <% if (contact.url && contact.url !== 'mailto:{contact}') { %>
                                <a href="<%= contact.url.replace('{contact}', contact.value) %>" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-<%= getContactIcon(contact.contactType.name) %>"></i> 
                                    <%= contact.value %>
                                </a>
                            <% } else { %>
                                <span>
                                    <i class="bi bi-<%= getContactIcon(contact.contactType.name) %>"></i> 
                                    <%= contact.value %>
                                </span>
                            <% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p class="mt-2 mb-0">No contact information available</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Recent Booking Activity -->
        <% if (gig.opportunity && gig.opportunity.interactions && gig.opportunity.interactions.length > 0) { %>
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Booking Activity
                    </h6>
                    <small class="text-muted">
                        Latest interactions for this gig
                    </small>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <% gig.opportunity.interactions.forEach((interaction, index) => { %>
                            <div class="timeline-item <%= index === 0 ? 'latest' : '' %>">
                                <div class="timeline-content">
                                    <div class="small text-muted mb-1">
                                        <%= new Date(interaction.interactionDate).toLocaleDateString() %> - <%= interaction.type %>
                                    </div>
                                    <% if (interaction.outcome) { %>
                                        <div class="mb-2">
                                            <span class="badge bg-<%= getInteractionStatusColor(interaction.outcome) %> small">
                                                <%= interaction.outcome.replace('_', ' ') %>
                                            </span>
                                        </div>
                                    <% } %>
                                    <% if (interaction.messageContent) { %>
                                        <div class="small">
                                            <%= interaction.messageContent.length > 100 ? interaction.messageContent.substring(0, 100) + '...' : interaction.messageContent %>
                                        </div>
                                    <% } %>
                                    <div class="small text-muted text-end mt-1">
                                        by <%= interaction.user.username %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/bands/<%= band.id %>/opportunities/<%= gig.opportunity.id %>" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> View All Activity
                        </a>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteGigModal" tabindex="-1" aria-labelledby="deleteGigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteGigModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Delete Gig
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this gig?</p>
                <div class="alert alert-warning">
                    <strong><%= gig.name %></strong><br>
                    <small class="text-muted">
                        <%= new Date(gig.gigDate).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) %> at <%= gig.venue.name %>
                    </small>
                </div>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>This action cannot be undone.</strong> All gig information will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <form action="/bands/<%= band.id %>/gigs/<%= gig.id %>/delete" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Gig
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<%
// Helper function to get status color for gig status
function getGigStatusColor(status) {
    const colors = {
        'CONFIRMED': 'success',
        'TENTATIVE': 'warning',
        'CANCELLED': 'danger',
        'COMPLETED': 'info'
    };
    return colors[status] || 'secondary';
}

// Helper function to get contact icon
function getContactIcon(contactType) {
    const icons = {
        'EMAIL': 'envelope',
        'PHONE_CALL': 'telephone',
        'FACEBOOK_MESSAGE': 'messenger',
        'INSTAGRAM_DM': 'instagram',
        'WEBSITE': 'globe',
        'OTHER': 'chat'
    };
    return icons[contactType] || 'chat';
}

// Helper function to get interaction status color
function getInteractionStatusColor(outcome) {
    const colors = {
        'FIRST_CONTACT': 'info',
        'FOLLOWING_UP': 'info',
        'SCHEDULING': 'warning',
        'NEGOTIATING': 'warning',
        'AWAITING_CONFIRMATION': 'warning',
        'BOOKED': 'success',
        'DETAILS': 'success',
        'DECLINED': 'danger',
        'REJECTED': 'danger',
        'NO_RESPONSE': 'danger',
        'CANCELLED': 'danger',
        'NOT_INTERESTED': 'danger'
    };
    return colors[outcome] || 'secondary';
}
%>

<style>
.timeline {
    position: relative;
}

.timeline-item {
    position: relative;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.timeline-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.timeline-item.latest {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    border: 2px solid #28a745;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeline-content {
    position: relative;
}

.timeline-content .badge {
    font-size: 0.7rem;
    padding: 0.25em 0.5em;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .timeline-item.latest {
        background-color: #343a40;
        border-color: #28a745;
    }
    
    .bg-light {
        background-color: #343a40 !important;
        color: #e9ecef;
    }
}

@media (max-width: 991px) {
    .col-lg-4, .col-lg-8 {
        margin-bottom: 2rem;
    }
    
    .col-lg-4:last-child {
        margin-bottom: 0;
    }
}
</style>
