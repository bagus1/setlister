<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">Click on the venue to book a gig</span>
            </div>
            <div>
                <a href="/bands/<%= band.id %>/opportunities" class="btn btn-outline-primary me-2">
                    <i class="bi bi-list"></i> All Opportunities
                </a>
                <a href="/bands/<%= band.id %>" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Band
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="searchVenues" placeholder="Search venues...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterCity">
                            <option value="">All Cities</option>
                            <!-- Cities will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterType">
                            <option value="">All Types</option>
                            <% if (bandVenues && bandVenues.length > 0) { %>
                                <%
                                // Get unique venue types from the band venues
                                var uniqueTypes = [];
                                var seenTypes = {};
                                for (var i = 0; i < bandVenues.length; i++) {
                                    var bandVenue = bandVenues[i];
                                    if (bandVenue.venue.venueType && !seenTypes[bandVenue.venue.venueType.name]) {
                                        uniqueTypes.push(bandVenue.venue.venueType.name);
                                        seenTypes[bandVenue.venue.venueType.name] = true;
                                    }
                                }
                                uniqueTypes.sort();
                                %>
                                <% for (var j = 0; j < uniqueTypes.length; j++) { %>
                                    <option value="<%= uniqueTypes[j] %>"><%= uniqueTypes[j] %></option>
                                <% } %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterStage">
                            <option value="">All Stages</option>
                            <option value="indoor">Indoor</option>
                            <option value="outdoor">Outdoor</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterState">
                            <option value="">All States</option>
                            <% if (bandVenues && bandVenues.length > 0) { %>
                                <%
                                // Get unique states from the band venues
                                var uniqueStates = [];
                                var seenStates = {};
                                for (var i = 0; i < bandVenues.length; i++) {
                                    var bandVenue = bandVenues[i];
                                    if (bandVenue.venue.state && !seenStates[bandVenue.venue.state]) {
                                        uniqueStates.push(bandVenue.venue.state);
                                        seenStates[bandVenue.venue.state] = true;
                                    }
                                }
                                uniqueStates.sort();
                                %>
                                <% for (var j = 0; j < uniqueStates.length; j++) { %>
                                    <option value="<%= uniqueStates[j] %>"><%= uniqueStates[j] %></option>
                                <% } %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterEmail">
                            <option value="">Has Email</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <% if (bandVenues && bandVenues.length > 0) { %>
            <div class="row">
                <% bandVenues.forEach(bandVenue => { %>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100" 
                             data-name="<%= bandVenue.venue.name.toLowerCase() %>"
                             data-city="<%= bandVenue.venue.city ? bandVenue.venue.city.toLowerCase() : '' %>"
                             data-state="<%= bandVenue.venue.state ? bandVenue.venue.state.toLowerCase() : '' %>"
                             data-type="<%= bandVenue.venue.venueType ? bandVenue.venue.venueType.name : '' %>"
                             data-stage="<%= bandVenue.venue.stage ? bandVenue.venue.stage.toLowerCase() : '' %>"
                             data-email="<%= bandVenue.venue.email ? 'yes' : 'no' %>">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">
                                        <%= bandVenue.venue.name %>
                                    </h5>
                                    <a href="/venues/<%= bandVenue.venue.id %>" class="btn btn-outline-info btn-sm" title="View Venue" style="position: relative; z-index: 2;">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                                
                                <!-- Clickable overlay for venue booking -->
                                <a href="/bands/<%= band.id %>/venues/<%= bandVenue.venue.id %>" class="text-decoration-none text-dark stretched-link" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1;" title="Click to book a gig at <%= bandVenue.venue.name %>"></a>
                                
                                <div class="mb-2">
                                    <% if (bandVenue.venue.venueType) { %>
                                        <span class="badge bg-primary me-1"><%= bandVenue.venue.venueType.name %></span>
                                    <% } %>
                                    <% if (bandVenue.venue.opportunities && bandVenue.venue.opportunities.length > 0) { %>
                                        <span class="badge bg-success" title="Active Opportunity: <%= bandVenue.venue.opportunities[0].name %>">
                                            <i class="bi bi-target"></i> Opportunity
                                        </span>
                                    <% } %>
                                </div>
                                
                                <% if (bandVenue.venue.city && bandVenue.venue.state) { %>
                                    <p class="text-muted mb-2">
                                        <%
                                            // Build Google Maps URL with full address for better accuracy
                                            let mapsUrl = '';
                                            if (bandVenue.venue.address) {
                                                mapsUrl = `https://maps.google.com/?q=${encodeURIComponent(bandVenue.venue.address + ', ' + bandVenue.venue.city + ', ' + bandVenue.venue.state + (bandVenue.venue.zipCode ? ' ' + bandVenue.venue.zipCode : ''))}`;
                                            } else {
                                                mapsUrl = `https://maps.google.com/?q=${encodeURIComponent(bandVenue.venue.city + ', ' + bandVenue.venue.state + (bandVenue.venue.zipCode ? ' ' + bandVenue.venue.zipCode : ''))}`;
                                            }
                                        %>
                                        <a href="<%= mapsUrl %>" target="_blank" class="text-decoration-none" style="position: relative; z-index: 2;">
                                            <i class="bi bi-geo-alt"></i> <%= bandVenue.venue.city %>, <%= bandVenue.venue.state %>
                                        </a>
                                    </p>
                                <% } %>
                                
                                
                                <% if (bandVenue.venue.stageLocation) { %>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-house"></i> Stage: <%= bandVenue.venue.stageLocation.charAt(0).toUpperCase() + bandVenue.venue.stageLocation.slice(1) %>
                                    </p>
                                <% } %>
                                
                                
                                <!-- Social Media -->
                                <% if (bandVenue.venue.socials && bandVenue.venue.socials.length > 0) { %>
                                    <div class="mb-2">
                                        <% bandVenue.venue.socials.slice(0, 4).forEach(social => { %>
                                            <%
                                                // Ensure website URLs have proper protocol
                                                let socialUrl = social.url || '#';
                                                if (social.socialType.name === 'Website' && socialUrl !== '#' && !socialUrl.startsWith('http')) {
                                                    socialUrl = 'https://' + socialUrl;
                                                }
                                            %>
                                            <a href="<%= socialUrl %>" target="_blank" class="text-decoration-none me-2" title="<%= social.socialType.name %>: <%= social.handle %>" style="position: relative; z-index: 2;">
                                                <i class="bi bi-<%= social.socialType.iconClass || 'link' %> fs-5"></i>
                                            </a>
                                        <% }); %>
                                        <% if (bandVenue.venue.socials.length > 4) { %>
                                            <span class="small text-muted">+<%= bandVenue.venue.socials.length - 4 %></span>
                                        <% } %>
                                    </div>
                                <% } %>
                                
                                <% if (bandVenue.venue.notes) { %>
                                    <p class="card-text small text-muted">
                                        <%= bandVenue.venue.notes.length > 100 ? 
                                            bandVenue.venue.notes.substring(0, 100) + '...' : 
                                            bandVenue.venue.notes %>
                                    </p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <i class="bi bi-geo-alt display-1 text-muted"></i>
                <h4 class="mt-3">No Venues Yet</h4>
                <p class="text-muted">Start building your venue network by adding venues to your band.</p>
                <a href="/bands/<%= band.id %>/venue-picker" class="btn btn-primary">
                    <i class="bi bi-plus"></i> Add Your First Venue
                </a>
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filtering functionality
    const searchInput = document.getElementById('searchVenues');
    const cityFilter = document.getElementById('filterCity');
    const typeFilter = document.getElementById('filterType');
    const stageFilter = document.getElementById('filterStage');
    const stateFilter = document.getElementById('filterState');
    const emailFilter = document.getElementById('filterEmail');
    const venueCards = document.querySelectorAll('.card.h-100');

    // Populate city filter
    const cities = new Set();
    venueCards.forEach(card => {
        const city = card.dataset.city;
        if (city) cities.add(card.dataset.city);
    });
    
    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city.charAt(0).toUpperCase() + city.slice(1);
        cityFilter.appendChild(option);
    });

    // Filter function
    function filterVenues() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCity = cityFilter.value.toLowerCase();
        const selectedType = typeFilter.value;
        const selectedStage = stageFilter.value.toLowerCase();
        const selectedState = stateFilter.value.toLowerCase();
        const selectedEmail = emailFilter.value;

        venueCards.forEach(card => {
            const name = card.dataset.name;
            const city = card.dataset.city;
            const state = card.dataset.state;
            const type = card.dataset.type;
            const stage = card.dataset.stage;
            const email = card.dataset.email;

            const matchesSearch = name.includes(searchTerm) || city.includes(searchTerm) || state.includes(searchTerm);
            const matchesCity = !selectedCity || city === selectedCity;
            const matchesType = !selectedType || type === selectedType;
            const matchesStage = !selectedStage || stage === selectedStage;
            const matchesState = !selectedState || state === selectedState;
            const matchesEmail = !selectedEmail || email === selectedEmail;

            if (matchesSearch && matchesCity && matchesType && matchesStage && matchesState && matchesEmail) {
                card.closest('.col-md-6').style.display = 'block';
            } else {
                card.closest('.col-md-6').style.display = 'none';
            }
        });
    }

    // Event listeners for filtering
    searchInput.addEventListener('input', filterVenues);
    cityFilter.addEventListener('change', filterVenues);
    typeFilter.addEventListener('change', filterVenues);
    stageFilter.addEventListener('change', filterVenues);
    stateFilter.addEventListener('change', filterVenues);
    emailFilter.addEventListener('change', filterVenues);
});
</script>

