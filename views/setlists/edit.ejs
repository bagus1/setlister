<div class="setlist-editor" data-setlist-id="<%= setlist.id %>">
    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success && success.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%- success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%- error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof warning !== 'undefined' && warning && warning.length > 0) { %>
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <%- warning %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="col-md-4">
                    <h1>Edit Setlist: <%= setlist.title %>
                    </h1>
                    <div class="d-flex align-items-center gap-3">
                        <span id="save-status" class="badge bg-secondary">Auto-saving...</span>
                        <small class="text-muted">Drag songs from the left to the sets on the right</small>
                    </div>
                </div>
                <div class="col-md-8 text-end">
                    <div class="btn-group" role="group">
                        <button id="save-setlist" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Now
                        </button>
                        <a href="/setlists/<%= setlist.id %>/finalize" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Finalize Setlist
                        </a>
                        <a href="/bands/<%= setlist.bandId %>/songs" class="btn btn-info">
                            <i class="bi bi-music-note-list"></i> Manage Songs
                        </a>
                        <a href="/bands/<%= setlist.bandId %>" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Band
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Band Songs Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-music-note-list"></i> Band Songs
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Song Filter -->
                    <div class="mb-3">
                        <input type="text" id="song-filter" class="form-control" placeholder="Filter songs by title..."
                            autocomplete="off">
                    </div>

                    <div id="band-songs-container" style="max-height: 600px; overflow-y: auto;">
                        <% if (bandSongs && bandSongs.length> 0) { %>
                            <% bandSongs.forEach(song=> { %>
                                <div class="song-card band-song" data-song-id="<%= song.id %>"
                                    data-song-time="<%= song.time || 0 %>"
                                    data-song-title="<%= song.title.toLowerCase() %>">
                                    <div class="song-title">
                                        <%= song.title %>
                                    </div>
                                    <% if (song.artists && song.artists.length> 0) { %>
                                        <div class="song-artist">by <%= song.artists[0].artist.name %>
                                        </div>
                                        <% } %>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <div class="d-flex align-items-center gap-2">
                                                    <% if (song.vocalist) { %>
                                                        <span class="song-vocalist">
                                                            <%= song.vocalist.name %>
                                                        </span>
                                                        <% } %>
                                                    <% if (song.key) { %>
                                                        <span class="song-key">
                                                            <%= song.key %>
                                                        </span>
                                                        <% } %>
                                                    <% if (song.links && song.links.length > 0) { %>
                                                        <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                                    <% } %>
                                                    <% if (song.gigDocuments && song.gigDocuments.length > 0) { %>
                                                        <i class="bi bi-file-earmark-text text-success" title="Has gig documents"></i>
                                                    <% } %>
                                                </div>
                                                <% if (song.time) { %>
                                                    <span class="song-time">
                                                        <%= Math.floor(song.time / 60) %>:<%= (song.time %
                                                                60).toString().padStart(2, '0' ) %>
                                                    </span>
                                                    <% } %>
                                            </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p class="text-muted">No songs assigned to this band yet. Select some songs on your <a href="/bands/<%= setlist.bandId %>/songs">Manage Songs page</a> first.
                                        </p>
                                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Add More Songs Box -->
            <div class="card mt-3">
                <div class="card-body text-center py-3">
                    <p class="mb-0">
                        <i class="bi bi-plus-circle text-primary me-2"></i>
                        Add more songs to this list on your <a href="/bands/<%= setlist.bandId %>/songs">Manage Songs</a> page
                    </p>
                </div>
            </div>
        </div>

        <!-- Setlist Sets Panel -->
        <div class="col-md-8">
            <div class="row">
                <% ['Set_1', 'Set_2' , 'Set_3' , 'Set_4' ].forEach((setName, index)=> { %>
                    <div class="col-md-6 mb-4">
                        <div class="set-header">
                            <%= setName.replace('_', ' ') %>
                                <span class="set-time float-end" data-set="<%= setName %>">0:00</span>
                        </div>
                        <div class="drop-zone <%= setlist.sets.find(s => s.name === setName && s.songs.length > 0) ? 'has-songs' : '' %>"
                            data-set-name="<%= setName %>">
                            <% const currentSet=setlist.sets.find(s=> s.name === setName); %>
                                <% if (currentSet && currentSet.songs) { %>
                                    <% currentSet.songs.forEach(setlistSong=> { %>
                                        <div class="song-card setlist-song" data-song-id="<%= setlistSong.song.id %>"
                                            data-song-time="<%= setlistSong.song.time || 0 %>"
                                            draggable="true">
                                            <div class="d-flex align-items-center" style="min-height: 1.2em;">
                                                <div class="song-title-text"
                                                    style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">
                                                    <%= setlistSong.song.title %>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger ms-2"
                                                    style="font-size: 0.7rem; padding: 0.1rem 0.3rem; line-height: 1;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                            <% if (setlistSong.song.artists && setlistSong.song.artists.length> 0) { %>
                                                <div class="song-artist">by <%= setlistSong.song.artists[0].artist.name %>
                                                </div>
                                                <% } %>
                                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <% if (setlistSong.song.vocalist) { %>
                                                                <span class="song-vocalist">
                                                                    <%= setlistSong.song.vocalist.name %>
                                                                </span>
                                                                <% } %>
                                                            <% if (setlistSong.song.key) { %>
                                                                <span class="song-key">
                                                                    <%= setlistSong.song.key %>
                                                                </span>
                                                                <% } %>
                                                            <% if (setlistSong.song.links && setlistSong.song.links.length > 0) { %>
                                                                <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                                            <% } %>
                                                            <% if (setlistSong.song.gigDocuments && setlistSong.song.gigDocuments.length > 0) { %>
                                                                <i class="bi bi-file-earmark-text text-success" title="Has gig documents"></i>
                                                            <% } %>
                                                        </div>
                                                        <% if (setlistSong.song.time) { %>
                                                            <span class="song-time">
                                                                <%= Math.floor(setlistSong.song.time / 60) %>:<%=
                                                                        (setlistSong.song.time %
                                                                        60).toString().padStart(2, '0' ) %>
                                                            </span>
                                                            <% } %>
                                                    </div>
                                        </div>
                                        <% }) %>
                                            <% } %>
                        </div>
                    </div>
                    <% }) %>

                        <!-- Maybe List -->
                        <div class="col-12">
                            <div class="set-header maybe-header">
                                Maybe List
                                <span class="song-count float-end" data-set="Maybe">(0 songs)</span>
                            </div>
                            <div class="drop-zone <%= setlist.sets.find(s => s.name === 'Maybe' && s.songs.length > 0) ? 'has-songs' : '' %>"
                                data-set-name="Maybe" style="min-height: 150px;">
                                <% const maybeSet=setlist.sets.find(s=> s.name === 'Maybe'); %>
                                    <% if (maybeSet && maybeSet.songs) { %>
                                        <% maybeSet.songs.forEach(setlistSong=> { %>
                                                                                    <div class="song-card setlist-song"
                                            data-song-id="<%= setlistSong.song.id %>"
                                            data-song-time="<%= setlistSong.song.time || 0 %>"
                                            draggable="true">
                                            <div class="d-flex align-items-center" style="min-height: 1.2em;">
                                                <div class="song-title-text"
                                                    style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">
                                                    <%= setlistSong.song.title %>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger ms-2"
                                                    style="font-size: 0.7rem; padding: 0.1rem 0.3rem; line-height: 1;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                                <% if (setlistSong.song.artists && setlistSong.song.artists.length> 0) {
                                                    %>
                                                    <div class="song-artist">by <%= setlistSong.song.artists[0].artist.name %>
                                                    </div>
                                                    <% } %>
                                                        <div
                                                            class="d-flex justify-content-between align-items-center mt-2">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <% if (setlistSong.song.vocalist) { %>
                                                                    <span class="song-vocalist">
                                                                        <%= setlistSong.song.vocalist.name %>
                                                                    </span>
                                                                    <% } %>
                                                                <% if (setlistSong.song.key) { %>
                                                                    <span class="song-key">
                                                                        <%= setlistSong.song.key %>
                                                                    </span>
                                                                    <% } %>
                                                                <% if (setlistSong.song.links && setlistSong.song.links.length > 0) { %>
                                                                    <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                                                <% } %>
                                                                <% if (setlistSong.song.gigDocuments && setlistSong.song.gigDocuments.length > 0) { %>
                                                                    <i class="bi bi-file-earmark-text text-success" title="Has gig documents"></i>
                                                                <% } %>
                                                            </div>
                                                            <% if (setlistSong.song.time) { %>
                                                                <span class="song-time">
                                                                    <%= Math.floor(setlistSong.song.time / 60) %>:<%=
                                                                            (setlistSong.song.time %
                                                                            60).toString().padStart(2, '0' ) %>
                                                                </span>
                                                                <% } %>
                                                        </div>
                                            </div>
                                            <% }) %>
                                                <% } %>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Drag and drop styles */
    .drag-over {
        background-color: rgba(0, 123, 255, 0.1) !important;
        border: 2px dashed #007bff !important;
    }

    .dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }

    /* Make setlist songs show they're draggable */
    .setlist-song {
        cursor: grab;
    }

    .setlist-song:active {
        cursor: grabbing;
    }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/js/setlist-editor.js"></script>

<script>
    // Initialize set times on load
    document.addEventListener('DOMContentLoaded', () => {
        // Song filter functionality
        const songFilter = document.getElementById('song-filter');
        const bandSongsContainer = document.getElementById('band-songs-container');
        const bandSongs = bandSongsContainer.querySelectorAll('.band-song');

        songFilter.addEventListener('input', (e) => {
            const filterValue = e.target.value.toLowerCase().trim();

            bandSongs.forEach(song => {
                const songTitle = song.dataset.songTitle;
                if (songTitle.includes(filterValue)) {
                    song.style.display = 'block';
                } else {
                    song.style.display = 'none';
                }
            });
        });

        // Clear filter when input is cleared
        songFilter.addEventListener('keyup', (e) => {
            if (e.target.value === '') {
                bandSongs.forEach(song => {
                    song.style.display = 'block';
                });
            }
        });

        ['Set_1', 'Set_2', 'Set_3', 'Set_4'].forEach(setName => {
            const dropZone = document.querySelector(`.drop-zone[data-set-name="${setName}"]`);
            const songs = dropZone.querySelectorAll('.setlist-song');
            let totalTime = 0;

            songs.forEach(song => {
                const time = parseInt(song.dataset.songTime) || 0;
                totalTime += time;
            });

            const timeDisplay = document.querySelector(`.set-time[data-set="${setName}"]`);
            if (timeDisplay) {
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        // Update Maybe count
        const maybeZone = document.querySelector('.drop-zone[data-set-name="Maybe"]');
        const maybeCount = maybeZone.querySelectorAll('.setlist-song').length;
        const countDisplay = document.querySelector('.song-count[data-set="Maybe"]');
        if (countDisplay) {
            countDisplay.textContent = `(${maybeCount} songs)`;
        }
    });
</script>