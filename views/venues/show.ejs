<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Venue Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (venue.address) { %>
                        <div class="col-md-6 mb-3">
                            <strong>Address:</strong><br>
                            <%= venue.address %><br>
                            <% if (venue.city) { %><%= venue.city %><% } %>
                            <% if (venue.city && venue.state) { %>, <% } %>
                            <% if (venue.state) { %><%= venue.state %><% } %>
                            <% if (venue.zipCode) { %> <%= venue.zipCode %><% } %>
                        </div>
                    <% } %>
                    
                    <!-- Direct venue phone number -->
                    <% if (venue.phone) { %>
                        <div class="col-md-6 mb-3">
                            <strong>Phone:</strong><br>
                            <i class="bi bi-telephone"></i>
                            <a href="tel:<%= venue.phone %>" class="text-decoration-none ms-1">
                                <%= venue.phone %>
                            </a>
                        </div>
                    <% } %>

                    <!-- Direct venue email -->
                    <% if (venue.email) { %>
                        <div class="col-md-6 mb-3">
                            <strong>Email:</strong><br>
                            <i class="bi bi-envelope"></i>
                            <a href="mailto:<%= venue.email %>" class="text-decoration-none ms-1">
                                <%= venue.email %>
                            </a>
                        </div>
                    <% } %>

                    <!-- Main venue website (from socials) -->
                    <% 
                        const mainWebsite = venue.socials?.find(social => social.socialType?.name === 'Website');
                    %>
                    <% if (mainWebsite && mainWebsite.url) { %>
                        <div class="col-12 mb-3">
                            <strong>Website:</strong><br>
                            <i class="bi bi-globe"></i>
                            <a href="<%= mainWebsite.url.startsWith('http') ? mainWebsite.url : 'https://' + mainWebsite.url %>" 
                               target="_blank" class="text-decoration-none ms-1">
                                <%= mainWebsite.url %>
                            </a>
                        </div>
                    <% } %>

                    <% 
                        // Filter out website contacts as they're for interactions, not display
                        const displayContacts = venue.contacts?.filter(contact => contact.contactType?.name !== 'WEBSITE') || [];
                    %>
                    <% if (displayContacts.length > 0) { %>
                        <div class="col-12 mb-3">
                            <strong>Additional Contact Information:</strong><br>
                            <% displayContacts.forEach(contact => { %>
                                <div class="mb-2">
                                    <% 
                                        // Fix icon class to avoid duplicate 'bi-'
                                        let iconClass = contact.contactType.iconClass || 'envelope';
                                        if (iconClass.startsWith('bi-')) {
                                            iconClass = iconClass.substring(3); // Remove 'bi-' prefix
                                        }
                                    %>
                                    <i class="bi bi-<%= iconClass %>"></i>
                                    <strong><%= contact.contactType.displayName %>:</strong>
                                    <% if (contact.url) { %>
                                        <a href="<%= contact.url %>" target="_blank" class="text-decoration-none ms-1">
                                            <%= contact.url %>
                                        </a>
                                    <% } else { %>
                                        <span class="ms-1"><%= contact.value %></span>
                                    <% } %>
                                    <% if (contact.label) { %>
                                        <small class="text-muted">(<%= contact.label %>)</small>
                                    <% } %>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>
                    
                    <% if (venue.socials && venue.socials.length > 0) { %>
                        <div class="col-12 mb-3">
                            <strong>Social Media:</strong><br>
                            <% venue.socials.forEach(social => { %>
                                <div class="mb-2">
                                    <i class="bi bi-<%= social.socialType.iconClass || 'globe' %>"></i>
                                    <strong><%= social.socialType.displayName %>:</strong>
                                    <% if (social.url) { %>
                                        <a href="<%= social.url %>" target="_blank" class="text-decoration-none ms-1">
                                            <%= social.handle %>
                                        </a>
                                    <% } else { %>
                                        <span class="ms-1"><%= social.handle %></span>
                                    <% } %>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <% if (venue.notes) { %>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Notes</h5>
                </div>
                <div class="card-body">
                    <%= venue.notes.replace(/\n/g, '<br>') %>
                </div>
            </div>
        <% } %>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Venue Info</h5>
            </div>
            <div class="card-body">
                <% if (venue.capacity) { %>
                    <div class="mb-3">
                        <strong>Capacity:</strong><br>
                        <i class="bi bi-people"></i> <%= venue.capacity.toLocaleString() %> people
                    </div>
                <% } %>
                
                <% if (venue.venueType) { %>
                    <div class="mb-3">
                        <strong>Type:</strong><br>
                        <span class="badge bg-secondary"><%= venue.venueType.name %></span>
                    </div>
                <% } %>
                
                <% if (venue.musicStyle) { %>
                    <div class="mb-3">
                        <strong>Music Style:</strong><br>
                        <span class="badge bg-warning text-dark"><%= venue.musicStyle %></span>
                    </div>
                <% } %>
                
                <% if (venue.stageLocation) { %>
                    <div class="mb-3">
                        <strong>Stage Location:</strong><br>
                        <span class="badge bg-info text-dark"><%= venue.stageLocation.charAt(0).toUpperCase() + venue.stageLocation.slice(1) %></span>
                    </div>
                <% } %>
                
                <% if (venue.bookingStatus) { %>
                    <div class="mb-3">
                        <strong>Booking Status:</strong><br>
                        <%= venue.bookingStatus %>
                    </div>
                <% } %>
                
                <% if (venue.leadTime) { %>
                    <div class="mb-3">
                        <strong>Lead Time:</strong><br>
                        <%= venue.leadTime %>
                    </div>
                <% } %>
            </div>
        </div>

        <% if (venue.soundSystem || venue.stageSize) { %>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Technical Details</h5>
                </div>
                <div class="card-body">
                    <% if (venue.soundSystem) { %>
                        <div class="mb-3">
                            <strong>Sound System:</strong><br>
                            <%= venue.soundSystem %>
                        </div>
                    <% } %>
                    
                    <% if (venue.stageSize) { %>
                        <div class="mb-3">
                            <strong>Stage Size:</strong><br>
                            <%= venue.stageSize %>
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>

        <% if (venue.fees) { %>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Fees & Payment</h5>
                </div>
                <div class="card-body">
                    <%= venue.fees %>
                </div>
            </div>
        <% } %>

        <% if (venue.socialMedia) { %>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Social Media</h5>
                </div>
                <div class="card-body">
                    <%= venue.socialMedia %>
                </div>
            </div>
        <% } %>
    </div>
</div>

<% if (loggedIn && currentUser && venue.createdById === currentUser.id) { %>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Venue Management</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/venues/<%= venue.id %>/edit" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Edit Venue
                        </a>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addContactModal">
                            <i class="bi bi-person-plus"></i> Add Contact
                        </button>
                        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addSocialModal">
                            <i class="bi bi-share"></i> Add Social Media
                        </button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash"></i> Delete Venue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addContactModalLabel">Add Contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addContactForm" method="POST" action="/venues/<%= venue.id %>/contacts">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="contactType" class="form-label">Contact Type *</label>
                            <select class="form-select" id="contactType" name="contactType" required>
                                <option value="">Select Type</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="contactValue" class="form-label">Value *</label>
                            <input type="text" class="form-control" id="contactValue" name="value" 
                                   placeholder="Phone, email, handle, etc." required>
                            <div id="contactValueHelp" class="form-text"></div>
                        </div>
                        <div class="mb-3">
                            <label for="contactLabel" class="form-label">Label</label>
                            <input type="text" class="form-control" id="contactLabel" name="label" 
                                   placeholder="e.g., Booking, General">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Contact</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Social Media Modal -->
    <div class="modal fade" id="addSocialModal" tabindex="-1" aria-labelledby="addSocialModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSocialModalLabel">Add Social Media</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addSocialForm" method="POST" action="/venues/<%= venue.id %>/socials">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="socialType" class="form-label">Platform *</label>
                            <select class="form-select" id="socialType" name="socialType" required>
                                <option value="">Select Platform</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="socialHandle" class="form-label">Handle *</label>
                            <input type="text" class="form-control" id="socialHandle" name="handle" 
                                   placeholder="@username or page name" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-info">Add Social Media</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Contact and Social types data
        const contactTypes = <%- JSON.stringify(typeof contactTypes !== 'undefined' ? contactTypes : []) %>;
        const socialTypes = <%- JSON.stringify(typeof socialTypes !== 'undefined' ? socialTypes : []) %>;

        function confirmDelete() {
            if (confirm('Are you sure you want to delete this venue? This action cannot be undone.')) {
                // Create a form to submit DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/venues/<%= venue.id %>';
                
                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'DELETE';
                
                form.appendChild(methodInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Populate contact types dropdown
        function populateContactTypes() {
            const contactTypeSelect = document.getElementById('contactType');
            if (contactTypeSelect && contactTypes && contactTypes.length > 0) {
                contactTypes.forEach(contactType => {
                    // Filter out contact types that don't make sense for venue contacts
                    if (contactType.name === 'IN_PERSON' || contactType.name === 'NOTE') {
                        return; // Skip these contact types
                    }
                    
                    const option = document.createElement('option');
                    option.value = contactType.id;
                    option.textContent = contactType.displayName;
                    contactTypeSelect.appendChild(option);
                });
                
                // Add change handler for validation hints
                contactTypeSelect.addEventListener('change', updateContactValueHelp);
            }
        }
        
        // Update help text and validation based on contact type
        function updateContactValueHelp() {
            const contactTypeSelect = document.getElementById('contactType');
            const contactValueInput = document.getElementById('contactValue');
            const helpDiv = document.getElementById('contactValueHelp');
            
            if (!contactTypeSelect.value) {
                helpDiv.textContent = '';
                contactValueInput.placeholder = 'Phone, email, handle, etc.';
                return;
            }
            
            const contactType = contactTypes.find(ct => ct.id == contactTypeSelect.value);
            if (!contactType) return;
            
            // Update placeholder and help text based on contact type
            switch (contactType.name) {
                case 'EMAIL':
                    contactValueInput.placeholder = 'email@example.com';
                    helpDiv.textContent = 'Enter a valid email address';
                    break;
                case 'PHONE_CALL':
                case 'TEXT':
                case 'WHATSAPP':
                    contactValueInput.placeholder = '+1234567890';
                    helpDiv.textContent = 'Enter phone number with country code (e.g., +1234567890)';
                    break;
                case 'FACEBOOK_MESSAGE':
                    contactValueInput.placeholder = 'Woodcellar or https://facebook.com/Woodcellar';
                    helpDiv.textContent = 'Enter Facebook username/page name or full URL';
                    break;
                case 'INSTAGRAM_MESSAGE':
                    contactValueInput.placeholder = 'woodcellardenver or https://instagram.com/woodcellardenver';
                    helpDiv.textContent = 'Enter Instagram username or full URL';
                    break;
                case 'LINKEDIN_MESSAGE':
                    contactValueInput.placeholder = 'company-name or https://linkedin.com/company/company-name';
                    helpDiv.textContent = 'Enter LinkedIn username/company name or full URL';
                    break;
                case 'TWITTER_MESSAGE':
                    contactValueInput.placeholder = 'woodcellar or https://twitter.com/woodcellar';
                    helpDiv.textContent = 'Enter Twitter username or full URL';
                    break;
                case 'TELEGRAM':
                    contactValueInput.placeholder = '@username or username';
                    helpDiv.textContent = 'Enter Telegram username (with or without @)';
                    break;
                case 'DISCORD':
                    contactValueInput.placeholder = 'username#1234 or server invite link';
                    helpDiv.textContent = 'Enter Discord username or server invite link';
                    break;
                case 'WEBSITE_CONTACT_FORM':
                case 'WEBSITE_LIVE_CHAT':
                    contactValueInput.placeholder = 'https://example.com/contact';
                    helpDiv.textContent = 'Enter the full URL to the contact form or chat';
                    break;
                default:
                    contactValueInput.placeholder = 'Enter contact information';
                    helpDiv.textContent = '';
            }
        }

        // Populate social types dropdown
        function populateSocialTypes() {
            const socialTypeSelect = document.getElementById('socialType');
            if (socialTypeSelect && socialTypes && socialTypes.length > 0) {
                socialTypes.forEach(socialType => {
                    const option = document.createElement('option');
                    option.value = socialType.id;
                    option.textContent = socialType.displayName;
                    socialTypeSelect.appendChild(option);
                });
            }
        }

        // Handle contact form submission
        document.getElementById('addContactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const contactTypeId = formData.get('contactType');
            const value = formData.get('value');
            const label = formData.get('label');
            
            // Find the contact type to get URL template
            const contactType = contactTypes.find(ct => ct.id == contactTypeId);
            let url = null;
            if (contactType && contactType.urlTemplate) {
                url = contactType.urlTemplate.replace('{contact}', value);
            }
            
            // Submit the form
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contactTypeId: parseInt(contactTypeId),
                    value: value,
                    label: label,
                    url: url
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh the page to show new contact
                } else {
                    alert('Error adding contact: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding contact');
            });
        });

        // Handle social form submission
        document.getElementById('addSocialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const socialTypeId = formData.get('socialType');
            const handle = formData.get('handle');
            
            // Find the social type to get URL template
            const socialType = socialTypes.find(st => st.id == socialTypeId);
            let url = null;
            if (socialType && socialType.urlTemplate) {
                // Clean the handle to remove any existing URLs
                let cleanHandle = handle.trim();
                if (cleanHandle.includes('facebook.com/')) {
                    // Extract just the username from a full Facebook URL
                    cleanHandle = cleanHandle.split('facebook.com/').pop().replace(/\/$/, '');
                } else if (cleanHandle.includes('instagram.com/')) {
                    // Extract just the username from a full Instagram URL
                    cleanHandle = cleanHandle.split('instagram.com/').pop().replace(/\/$/, '');
                } else if (cleanHandle.includes('twitter.com/')) {
                    // Extract just the username from a full Twitter URL
                    cleanHandle = cleanHandle.split('twitter.com/').pop().replace(/\/$/, '');
                }
                url = socialType.urlTemplate.replace('{contact}', cleanHandle);
            }
            
            // Submit the form
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    socialTypeId: parseInt(socialTypeId),
                    handle: handle,
                    url: url
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh the page to show new social
                } else {
                    alert('Error adding social media: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding social media');
            });
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Contact types:', contactTypes);
            console.log('Social types:', socialTypes);
            populateContactTypes();
            populateSocialTypes();
        });
    </script>
<% } %>
