<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Playlist</h1>
                    <h2 class="h4 text-muted">
                        <%= setlist.title %> - <%= setlist.Band.name %>
                    </h2>
                </div>
                <div>
                    <a href="/setlists/<%= setlist.id %>/finalize" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Setlist
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-music-note-list"></i> Audio Playlist
                    </h5>
                </div>
                <div class="card-body">
                    <% if (audioSongs.length > 0) { %>
                        <div class="audio-player mb-4">
                            <audio id="audio" controls preload="auto" class="w-100">
                                <source src="<%= audioSongs[0].song.Links[0].url %>" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="player-controls mt-3">
                                <button id="prevBtn" class="control-btn" onclick="playPreviousSong()">
                                    <i class="bi bi-skip-backward bold-icon"></i>
                                </button>
                                <button id="restartBtn" class="control-btn" onclick="restartCurrentSong()">
                                    <i class="bi bi-arrow-repeat bold-icon"></i>
                                </button>
                                <button id="nextBtn" class="control-btn" onclick="playNextSong()">
                                    <i class="bi bi-skip-forward bold-icon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <ul id="playlist" class="playlist">
                            <% audioSongs.forEach((audioSong, index) => { %>
                                <li class="<%= index === 0 ? 'active' : '' %>" data-url="<%= audioSong.song.Links[0].url %>">
                                    <a href="#" onclick="playSong(this.parentElement, event)">
                                        <div class="song-info">
                                            <div>
                                                <div class="song-title"><%= audioSong.song.title %></div>
                                                <div class="song-details">
                                                    <% if (audioSong.song.Artists && audioSong.song.Artists.length > 0) { %>
                                                        by <%= audioSong.song.Artists[0].name %>
                                                    <% } %>
                                                    <% if (audioSong.song.key) { %>
                                                        • Key: <%= audioSong.song.key %>
                                                    <% } %>
                                                    <% if (audioSong.song.time) { %>
                                                        • <%= Math.floor(audioSong.song.time / 60) %>:<%= (audioSong.song.time % 60).toString().padStart(2, '0') %>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <span class="set-label"><%= audioSong.set %></span>
                                        </div>
                                    </a>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <div class="no-audio text-center py-5">
                            <h3>No Audio Files Found</h3>
                            <p class="text-muted">This setlist doesn't contain any songs with audio links.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .audio-player {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .player-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .control-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .control-btn:hover {
        background: #0056b3;
    }
    
    .control-btn:active {
        background: #004085;
    }
    
    .control-btn i {
        font-size: large;
    }
    
    .bold-icon {
        -webkit-text-stroke: .3px white;
    }
    
    .playlist {
        padding: 0;
        margin: 0;
        list-style: none;
    }
    
    .playlist li {
        padding: 10px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .playlist li:hover {
        background-color: #f8f9fa;
    }
    
    .playlist li.active {
        background-color: #007bff !important;
        color: white;
    }
    
    .playlist li.active a {
        color: white;
    }
    
    .playlist li.active .song-title {
        color: white;
        font-weight: bold;
    }
    
    .playlist li.active .song-details {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .playlist li.active .set-label {
        background: #ffffff;
        color: #007bff;
    }
    
    .playlist li:nth-child(odd) {
        background-color: #f8f9fa;
    }
    
    .playlist li:nth-child(even) {
        background-color: white;
    }
    
    .playlist li a {
        color: #333;
        text-decoration: none;
        display: block;
    }
    
    .song-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .song-title {
        font-weight: bold;
    }
    
    .song-details {
        font-size: 14px;
        opacity: 0.7;
    }
    
    .set-label {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .no-audio {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

<script>
    let currentSong = 0;
    const audio = document.getElementById('audio');
    const playlist = document.getElementById('playlist');
    const tracks = playlist ? playlist.querySelectorAll('li') : [];

    if (audio && tracks.length > 0) {
        // Set initial volume
        audio.volume = 0.5;

        // Auto-play next song when current one ends
        audio.addEventListener('ended', function() {
            currentSong++;
            if (currentSong >= tracks.length) {
                currentSong = 0; // Loop back to first song
            }
            playSong(tracks[currentSong]);
        });
    }

    function playSong(songElement, event) {
        if (event) {
            event.preventDefault();
        }
        
        if (!songElement || !audio) return;

        // Update active state
        document.querySelectorAll('#playlist li').forEach(li => li.classList.remove('active'));
        songElement.classList.add('active');

        // Get song URL and play
        const songUrl = songElement.dataset.url;
        if (songUrl) {
            audio.src = songUrl;
            audio.load();
            audio.play();
            
            // Update current song index
            currentSong = Array.from(tracks).indexOf(songElement);
        }
    }
    
    function restartCurrentSong() {
        if (audio) {
            audio.currentTime = 0;
            audio.play();
        }
    }
    
    function playNextSong() {
        if (tracks.length === 0) return;
        
        currentSong++;
        if (currentSong >= tracks.length) {
            currentSong = 0; // Loop back to first song
        }
        playSong(tracks[currentSong]);
    }
    
    function playPreviousSong() {
        if (tracks.length === 0) return;
        
        currentSong--;
        if (currentSong < 0) {
            currentSong = tracks.length - 1; // Loop to last song
        }
        playSong(tracks[currentSong]);
    }
</script>
