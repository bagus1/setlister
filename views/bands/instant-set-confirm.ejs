<%- include('../layout', { title: title, user: user, currentUrl: currentUrl }) %>

<% contentFor('body') %>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-check-circle text-success"></i> Confirm Your Set
                    </h1>
                    <p class="text-muted mb-0">Band: <%= band.name %> | Setlist: <%= setlistTitle %></p>
                    <% if (setlistDate) { %>
                        <p class="text-muted mb-0">Date: <%= new Date(setlistDate).toLocaleDateString() %></p>
                    <% } %>
                </div>
                <div>
                    <a href="/bands/<%= band.id %>/instant-set" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Form
                    </a>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Review your songs below.</strong> The best match for each song is pre-selected. 
                You can change selections or add missing artist information before creating your setlist.
            </div>

            <form method="POST" action="/bands/<%= band.id %>/instant-set/create">
                <input type="hidden" name="setlistTitle" value="<%= setlistTitle %>">
                <input type="hidden" name="setlistDate" value="<%= setlistDate %>">
                <input type="hidden" name="songList" value="<%= songList %>">

                <% sets.forEach((set, setIndex) => { %>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-music-note-list"></i> <%= set.name %>
                                <span class="badge bg-secondary ms-2"><%= set.songs.length %> songs</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <% set.songs.forEach((song, songIndex) => { %>
                                <div class="song-confirmation-card mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-2">
                                                <span class="badge bg-secondary me-2"><%= songIndex + 1 %></span>
                                                <%= song.originalLine %>
                                            </h6>
                                            
                                            <% if (song.isNewSong) { %>
                                                <!-- New Song Section -->
                                                <div class="alert alert-warning mb-2">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    <strong>New Song Detected</strong> - This appears to be a new song not in our system.
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Song Title</label>
                                                        <input type="text" class="form-control" name="songs[<%= setIndex %>][<%= songIndex %>][title]" value="<%= song.title %>" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Artist</label>
                                                        <input type="text" class="form-control" name="songs[<%= setIndex %>][<%= songIndex %>][artist]" value="<%= song.artist %>" placeholder="Enter artist name">
                                                    </div>
                                                </div>
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][action]" value="create">
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][setName]" value="<%= set.name %>">
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][order]" value="<%= songIndex + 1 %>">
                                            <% } else { %>
                                                <!-- Existing Song Section -->
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Selected Song</label>
                                                        <div class="form-control-plaintext">
                                                            <strong><%= song.bestMatch.song.title %></strong>
                                                            <% if (song.bestMatch.song.Artists && song.bestMatch.song.Artists.length > 0) { %>
                                                                by <em><%= song.bestMatch.song.Artists[0].name %></em>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Match Confidence</label>
                                                        <div class="form-control-plaintext">
                                                            <span class="badge bg-<%= song.bestMatch.confidence === 'exact' ? 'success' : song.bestMatch.confidence === 'title-only' ? 'warning' : 'info' %>">
                                                                <%= song.bestMatch.reason %>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][action]" value="use">
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][songId]" value="<%= song.bestMatch.song.id %>">
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][setName]" value="<%= set.name %>">
                                                <input type="hidden" name="songs[<%= setIndex %>][<%= songIndex %>][order]" value="<%= songIndex + 1 %>">
                                            <% } %>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <% if (!song.isNewSong && song.matches.length > 1) { %>
                                                <label class="form-label">Other Options</label>
                                                <div class="list-group">
                                                    <% song.matches.slice(1).forEach((match, matchIndex) => { %>
                                                        <label class="list-group-item">
                                                            <input class="form-check-input me-1" type="radio" name="songs[<%= setIndex %>][<%= songIndex %>][songId]" value="<%= match.song.id %>" <%= matchIndex === 0 ? '' : 'onchange="updateSongSelection(this, ' + setIndex + ', ' + songIndex + ')"' %>>
                                                            <div class="small">
                                                                <strong><%= match.song.title %></strong>
                                                                <% if (match.song.Artists && match.song.Artists.length > 0) { %>
                                                                    <br><em><%= match.song.Artists[0].name %></em>
                                                                <% } %>
                                                                <br><span class="text-muted"><%= match.reason %></span>
                                                            </div>
                                                        </label>
                                                    <% }) %>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% }) %>

                <div class="d-flex justify-content-between mb-4">
                    <a href="/bands/<%= band.id %>/instant-set" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Form
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Confirm Songs & Create Setlist
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateSongSelection(radio, setIndex, songIndex) {
    // Update the hidden input for songId when a different option is selected
    const songIdInput = radio.closest('.song-confirmation-card').querySelector('input[name*="[songId]"]');
    if (songIdInput) {
        songIdInput.value = radio.value;
    }
    
    // Update the action to 'use' since we're selecting an existing song
    const actionInput = radio.closest('.song-confirmation-card').querySelector('input[name*="[action]"]');
    if (actionInput) {
        actionInput.value = 'use';
    }
}
</script>
