<div class="setlist-editor" data-setlist-id="<%= setlist.id %>">
    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success && success.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%- success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%- error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof warning !== 'undefined' && warning && warning.length > 0) { %>
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <%- warning %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="col-md-4">
                    <h1>Edit Setlist: <%= setlist.title %>
                    </h1>
                    <div class="d-flex align-items-center gap-3">
                        <span id="save-status" class="badge bg-secondary">Auto-saving...</span>
                        <small class="text-muted">Drag songs from the left to the sets on the right</small>
                    </div>
                </div>
                <div class="col-md-8 text-end">
                    <div class="btn-group" role="group">
                        <a href="/setlists/<%= setlist.id %>" class="btn btn-success">
                            <i class="bi bi-eye"></i> View Setlist
                        </a>
                        <button id="change-log-btn" class="btn btn-primary">
                            <i class="bi bi-clock-history"></i> Change Log
                        </button>
                        <a href="/bands/<%= setlist.bandId %>/songs" class="btn btn-info">
                            <i class="bi bi-music-note-list"></i> Manage Songs
                        </a>
                        <a href="/bands/<%= setlist.bandId %>" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Band
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Band Songs Panel -->
        <div class="col-md-4 band-songs-fixed">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-music-note-list"></i> Band Songs
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Song Filter -->
                    <div class="mb-3">
                        <input type="text" id="song-filter" class="form-control" placeholder="Filter songs by title..."
                            autocomplete="off">
                    </div>

                    <div id="band-songs-container" style="max-height: 600px; overflow-y: auto;">
                        <% if (bandSongs && bandSongs.length> 0) { %>
                            <% bandSongs.forEach(song=> { %>
                                <div class="song-card band-song" data-song-id="<%= song.id %>"
                                    data-song-time="<%= song.time || 0 %>"
                                    data-song-title="<%= song.title.toLowerCase() %>">
                                    <div class="song-title text-muted">
                                        <%= song.title %>
                                    </div>
                                                                                <div class="d-flex justify-content-between align-items-center mt-1">
                                        <div class="d-flex align-items-center gap-2">
                                            <% if (song.vocalist) { %>
                                                <span class="song-vocalist">
                                                    <%= song.vocalist.name %>
                                                </span>
                                                <% } %>
                                            <% if (song.key) { %>
                                                <span class="song-key">
                                                    <%= song.key %>
                                                </span>
                                                <% } %>
                                            <% if (song.links && song.links.length > 0) { %>
                                                <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                            <% } %>
                                            <% if (song.gigDocuments && song.gigDocuments.length > 0) { %>
                                                <i class="bi bi-file-earmark-text text-success" title="Has Music Stand documents"></i>
                                            <% } %>
                                        </div>
                                        <% if (song.time) { %>
                                            <span class="song-time">
                                                <%= Math.floor(song.time / 60) %>:<%= (song.time %
                                                                60).toString().padStart(2, '0' ) %>
                                            </span>
                                            <% } %>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p class="text-muted">No songs assigned to this band yet. Select some songs on your <a href="/bands/<%= setlist.bandId %>/songs">Manage Songs page</a> first.
                                        </p>
                                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Add More Songs Box -->
            <div class="card mt-3">
                <div class="card-body text-center py-3">
                    <p class="mb-0">
                        <i class="bi bi-plus-circle text-primary me-2"></i>
                        Add more songs to this list on your <a href="/bands/<%= setlist.bandId %>/songs">Manage Songs</a> page
                    </p>
                </div>
            </div>
        </div>

        <!-- Setlist Sets Panel -->
        <div class="col-md-8">
            <div class="row">
                <% ['Set_1', 'Set_2' , 'Set_3' , 'Set_4' ].forEach((setName, index)=> { %>
                    <div class="col-md-6 mb-4">
                        <div class="set-header">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span class="set-name-display" data-set-name="<%= setName %>">
                                        <%= setName.replace('_', ' ') %>
                                    </span>
                                    <input type="text" class="form-control form-control-sm set-name-input d-none ms-2" 
                                           data-set-name="<%= setName %>" 
                                           data-setlist-id="<%= setlist.id %>"
                                           value="<%= setName.replace('_', ' ') %>"
                                           style="width: 120px;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 edit-set-name-btn" 
                                            data-set-name="<%= setName %>"
                                            title="Edit set name">
                                        <i class="bi bi-pencil" style="font-size: 0.8rem;"></i>
                                    </button>
                                </div>
                                <span class="set-time" data-set="<%= setName %>">0:00</span>
                            </div>
                        </div>
                        <div class="drop-zone <%= setlist.sets.find(s => s.name === setName && s.songs.length > 0) ? 'has-songs' : '' %>"
                            data-set-name="<%= setName %>">
                            <% const currentSet=setlist.sets.find(s=> s.name === setName); %>
                                <% if (currentSet && currentSet.songs) { %>
                                    <% currentSet.songs.forEach(setlistSong=> { %>
                                        <div class="song-card setlist-song" data-song-id="<%= setlistSong.song.id %>"
                                            data-song-time="<%= setlistSong.song.time || 0 %>"
                                            draggable="true">
                                            <div class="d-flex align-items-center" style="min-height: 1.2em;">
                                                <div class="song-title-text text-muted"
                                                    style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">
                                                    <%= setlistSong.song.title %>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger ms-2"
                                                    style="font-size: 0.7rem; padding: 0.1rem 0.3rem; line-height: 1;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <% if (setlistSong.song.vocalist) { %>
                                                                <span class="song-vocalist">
                                                                    <%= setlistSong.song.vocalist.name %>
                                                                </span>
                                                                <% } %>
                                                            <% if (setlistSong.song.key) { %>
                                                                <span class="song-key">
                                                                    <%= setlistSong.song.key %>
                                                                </span>
                                                                <% } %>
                                                            <% if (setlistSong.song.links && setlistSong.song.links.length > 0) { %>
                                                                <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                                            <% } %>
                                                            <% if (setlistSong.song.gigDocuments && setlistSong.song.gigDocuments.length > 0) { %>
                                                                <i class="bi bi-file-earmark-text text-success" title="Has Music Stand documents"></i>
                                                            <% } %>
                                                        </div>
                                                        <% if (setlistSong.song.time) { %>
                                                            <span class="song-time">
                                                                <%= Math.floor(setlistSong.song.time / 60) %>:<%=
                                                                        (setlistSong.song.time %
                                                                        60).toString().padStart(2, '0' ) %>
                                                            </span>
                                                            <% } %>
                                                    </div>
                                        </div>
                                        <% }) %>
                                            <% } %>
                        </div>
                    </div>
                    <% }) %>

                        <!-- Maybe List -->
                        <div class="col-12">
                            <div class="set-header maybe-header">
                                Maybe List
                                <span class="song-count float-end" data-set="Maybe">(0 songs)</span>
                            </div>
                            <div class="drop-zone <%= setlist.sets.find(s => s.name === 'Maybe' && s.songs.length > 0) ? 'has-songs' : '' %>"
                                data-set-name="Maybe" style="min-height: 150px;">
                                <% const maybeSet=setlist.sets.find(s=> s.name === 'Maybe'); %>
                                    <% if (maybeSet && maybeSet.songs) { %>
                                        <% maybeSet.songs.forEach(setlistSong=> { %>
                                                                                    <div class="song-card setlist-song"
                                            data-song-id="<%= setlistSong.song.id %>"
                                            data-song-time="<%= setlistSong.song.time || 0 %>"
                                            draggable="true">
                                            <div class="d-flex align-items-center" style="min-height: 1.2em;">
                                                <div class="song-title-text text-muted"
                                                    style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">
                                                    <%= setlistSong.song.title %>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger ms-2"
                                                    style="font-size: 0.7rem; padding: 0.1rem 0.3rem; line-height: 1;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                                <% if (setlistSong.song.artists && setlistSong.song.artists.length> 0) {
                                                    %>
                                                    <div class="song-artist">by <%= setlistSong.song.artists[0].artist.name %>
                                                    </div>
                                                    <% } %>
                                                        <div
                                                            class="d-flex justify-content-between align-items-center mt-2">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <% if (setlistSong.song.vocalist) { %>
                                                                    <span class="song-vocalist">
                                                                        <%= setlistSong.song.vocalist.name %>
                                                                    </span>
                                                                    <% } %>
                                                                <% if (setlistSong.song.key) { %>
                                                                    <span class="song-key">
                                                                        <%= setlistSong.song.key %>
                                                                    </span>
                                                                    <% } %>
                                                                <% if (setlistSong.song.links && setlistSong.song.links.length > 0) { %>
                                                                    <i class="bi bi-link-45deg text-primary" title="Has links"></i>
                                                                <% } %>
                                                                <% if (setlistSong.song.gigDocuments && setlistSong.song.gigDocuments.length > 0) { %>
                                                                    <i class="bi bi-file-earmark-text text-success" title="Has Music Stand documents"></i>
                                                                <% } %>
                                                            </div>
                                                            <% if (setlistSong.song.time) { %>
                                                                <span class="song-time">
                                                                    <%= Math.floor(setlistSong.song.time / 60) %>:<%=
                                                                            (setlistSong.song.time %
                                                                            60).toString().padStart(2, '0' ) %>
                                                                </span>
                                                                <% } %>
                                                        </div>
                                            </div>
                                            <% }) %>
                                                <% } %>
                            </div>
                        </div>

                        <!-- Version History Section -->
                        <div class="col-12 mt-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Version History</h5>
                                    <button id="refresh-versions" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="version-loading" class="text-center" style="display: none;">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading versions...</span>
                                    </div>
                                    <div id="version-error" class="alert alert-danger" style="display: none;">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <span id="version-error-text">Failed to load versions</span>
                                    </div>
                                    <div id="version-list" class="version-list">
                                        <!-- Versions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS moved to /css/pages.css and /css/utilities.css -->

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/js/setlist-editor.js"></script>

<script>
    // Initialize set times on load
    document.addEventListener('DOMContentLoaded', () => {
        // Song filter functionality
        const songFilter = document.getElementById('song-filter');
        const bandSongsContainer = document.getElementById('band-songs-container');
        const bandSongs = bandSongsContainer.querySelectorAll('.band-song');

        songFilter.addEventListener('input', (e) => {
            const filterValue = e.target.value.toLowerCase().trim();

            bandSongs.forEach(song => {
                const songTitle = song.dataset.songTitle;
                if (songTitle.includes(filterValue)) {
                    song.style.display = 'block';
                } else {
                    song.style.display = 'none';
                }
            });
        });

        // Clear filter when input is cleared
        songFilter.addEventListener('keyup', (e) => {
            if (e.target.value === '') {
                bandSongs.forEach(song => {
                    song.style.display = 'block';
                });
            }
        });

        ['Set_1', 'Set_2', 'Set_3', 'Set_4'].forEach(setName => {
            const dropZone = document.querySelector(`.drop-zone[data-set-name="${setName}"]`);
            const songs = dropZone.querySelectorAll('.setlist-song');
            let totalTime = 0;

            songs.forEach(song => {
                const time = parseInt(song.dataset.songTime) || 0;
                totalTime += time;
            });

            const timeDisplay = document.querySelector(`.set-time[data-set="${setName}"]`);
            if (timeDisplay) {
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        // Update Maybe count
        const maybeZone = document.querySelector('.drop-zone[data-set-name="Maybe"]');
        const maybeCount = maybeZone.querySelectorAll('.setlist-song').length;
        const countDisplay = document.querySelector('.song-count[data-set="Maybe"]');
        if (countDisplay) {
            countDisplay.textContent = `(${maybeCount} songs)`;
        }

        // Set name editing functionality
        const editButtons = document.querySelectorAll('.edit-set-name-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const setName = this.dataset.setName;
                const displaySpan = document.querySelector(`.set-name-display[data-set-name="${setName}"]`);
                const inputField = document.querySelector(`.set-name-input[data-set-name="${setName}"]`);
                
                // Hide display, show input
                displaySpan.classList.add('d-none');
                inputField.classList.remove('d-none');
                inputField.focus();
                inputField.select();
            });
        });

        // Handle saving on blur
        const setNameInputs = document.querySelectorAll('.set-name-input');
        setNameInputs.forEach(input => {
            input.addEventListener('blur', function() {
                saveSetName(this);
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                }
            });
        });

        function saveSetName(inputElement) {
            const setName = inputElement.dataset.setName;
            const setlistId = inputElement.dataset.setlistId;
            const newName = inputElement.value.trim();
            const displaySpan = document.querySelector(`.set-name-display[data-set-name="${setName}"]`);
            
            if (newName && newName !== displaySpan.textContent.trim()) {
                // Save via AJAX
                fetch(`/setlists/${setlistId}/update-set-name`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        oldName: setName,
                        newName: newName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySpan.textContent = newName;
                    } else {
                        // Revert on error
                        inputElement.value = displaySpan.textContent;
                        alert('Error updating set name: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    inputElement.value = displaySpan.textContent;
                    alert('Error updating set name');
                });
            }
            
            // Hide input, show display
            inputElement.classList.add('d-none');
            displaySpan.classList.remove('d-none');
        }
    });

    // Version History JavaScript
    const setlistId = <%= setlist.id %>;
    const bandId = <%= setlist.bandId %>;

    // Load version history
    async function loadVersionHistory() {
        const loadingEl = document.getElementById('version-loading');
        const errorEl = document.getElementById('version-error');
        const listEl = document.getElementById('version-list');

        // Show loading
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        listEl.innerHTML = '';

        try {
            const response = await fetch(`/bands/${bandId}/setlists/${setlistId}/versions`);
            if (!response.ok) {
                throw new Error('Failed to load versions');
            }

            const data = await response.json();
            displayVersions(data.versions);
        } catch (error) {
            console.error('Error loading versions:', error);
            errorEl.style.display = 'block';
            document.getElementById('version-error-text').textContent = error.message;
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    // Display versions
    function displayVersions(versions) {
        const listEl = document.getElementById('version-list');
        
        if (versions.length === 0) {
            listEl.innerHTML = '<div class="text-muted text-center py-3">No versions yet. Make changes to create versions.</div>';
            return;
        }

        listEl.innerHTML = versions.map(version => createVersionElement(version)).join('');
    }

    // Create version element
    function createVersionElement(version) {
        const timestamp = new Date(version.timestamp).toLocaleString();
        
        return `
            <a href="/bands/${bandId}/setlists/${setlistId}/versions/${version.id}/view" class="version-item">
                <div class="version-header">
                    <div>
                        <div class="version-timestamp">Version ${version.versionNumber} - ${timestamp}</div>
                        <div class="version-user">by ${version.user}</div>
                        <div class="version-summary">${version.changeSummary}</div>
                    </div>
                    <div class="version-actions">
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                </div>
            </a>
        `;
    }

    // Event listeners
    document.getElementById('refresh-versions').addEventListener('click', loadVersionHistory);
    
    // Change Log button - scroll to version history section
    document.getElementById('change-log-btn').addEventListener('click', function(e) {
        e.preventDefault();
        const versionSection = document.querySelector('#version-list').closest('.card');
        versionSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    });

    // Load version history on page load
    document.addEventListener('DOMContentLoaded', loadVersionHistory);
</script>