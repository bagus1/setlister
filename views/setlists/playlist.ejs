<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Playlist</h1>
                    <h2 class="h4 text-muted">
                        <%= setlist.title %> - <%= setlist.band.name %>
                    </h2>
                </div>
                <div>
                    <a href="/setlists/<%= setlist.id %>" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Setlist
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-music-note-list"></i> Audio Playlist
                    </h5>
                </div>
                <div class="card-body">
                    <% if (audioSongs.length > 0) { %>
                        <div class="audio-player mb-4">
                            <audio id="audio" controls preload="auto" class="w-100">
                                <source src="<%= audioSongs[0].song.links[0].url %>" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="player-controls mt-3">
                                <button id="prevBtn" class="control-btn" onclick="playPreviousSong()">
                                    <i class="bi bi-skip-backward bold-icon"></i>
                                </button>
                                <button id="restartBtn" class="control-btn" onclick="restartCurrentSong()">
                                    <i class="bi bi-arrow-repeat bold-icon"></i>
                                </button>
                                <button id="nextBtn" class="control-btn" onclick="playNextSong()">
                                    <i class="bi bi-skip-forward bold-icon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <ul id="playlist" class="playlist">
                            <% 
                            let currentSet = null;
                            let setSongCount = 0;
                            %>
                            <% audioSongs.forEach((audioSong, index) => { %>
                                <% 
                                // Check if we're starting a new set
                                if (currentSet !== audioSong.set) {
                                    // Reset counters for new set
                                    currentSet = audioSong.set;
                                    setSongCount = 0;
                                }
                                setSongCount++;
                                %>
                                <li class="<%= index === 0 ? 'active' : '' %>" data-url="<%= audioSong.song.links[0].url %>">
                                    <a href="#" onclick="playSong(this.parentElement, event)">
                                        <div class="song-info">
                                            <div class="song-title">
                                                <strong><%= audioSong.song.title %></strong>
                                                <% if (audioSong.song.artists && audioSong.song.artists.length > 0) { %>
                                                    • <%= audioSong.song.artists[0].artist.name %>
                                                <% } %>
                                                <% if (audioSong.song.key) { %>
                                                    • Key: <%= audioSong.song.key %> 
                                                <% } %>
                                                <% if (audioSong.duration) { %>
                                                    • <%= audioSong.duration %>
                                                <% } %>
                                            </div>
                                            <div class="song-details">
                                                <small>
                                                    Set: <%= audioSong.set %>
                                                    <% if (audioSong.order) { %>
                                                        • Order: <%= audioSong.order %>
                                                    <% } %>
                                                </small>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <div class="no-audio text-center py-5">
                            <h3>No Audio Files Found</h3>
                            <p class="text-muted">This setlist doesn't contain any songs with audio links.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator"></i> Set Summaries
                    </h5>
                </div>
                <div class="card-body">
                    <% if (audioSongs.length > 0) { %>
                        <% 
                        let currentSet = null;
                        let setSongCount = 0;
                        %>
                        <% audioSongs.forEach((audioSong, index) => { %>
                            <% 
                            // Check if we're starting a new set
                            if (currentSet !== audioSong.set) {
                                // Print summary for previous set if it exists
                                if (currentSet && setSongCount > 0) { %>
                                    <div class="set-summary-card mb-3">
                                        <div class="set-summary-header">
                                            <strong><%= currentSet %></strong>
                                        </div>
                                        <div class="set-summary-stats">
                                            <span class="song-count"><%= setSongCount %> songs</span>
                                            <% if (setTotals[currentSet]) { %>
                                                <span class="set-time"><%= Math.floor(setTotals[currentSet] / 60) %>:<%= (setTotals[currentSet] % 60).toString().padStart(2, '0') %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>
                                <% 
                                // Reset counters for new set
                                currentSet = audioSong.set;
                                setSongCount = 0;
                            }
                            setSongCount++;
                            %>
                        <% }); %>
                        
                        <% 
                        // Print summary for the last set
                        if (currentSet && setSongCount > 0) { %>
                            <div class="set-summary-card mb-3">
                                <div class="set-summary-header">
                                    <strong><%= currentSet %></strong>
                                </div>
                                <div class="set-summary-stats">
                                    <span class="song-count"><%= setSongCount %> songs</span>
                                    <% if (setTotals[currentSet]) { %>
                                        <span class="set-time"><%= Math.floor(setTotals[currentSet] / 60) %>:<%= (setTotals[currentSet] % 60).toString().padStart(2, '0') %></span>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                        
                        <hr class="my-4">
                        
                        <div class="total-summary-card">
                            <div class="total-summary-header">
                                <strong>Total (Excluding Maybe)</strong>
                            </div>
                            <div class="total-summary-stats">
                                <% 
                                const numberedSongCount = audioSongs.filter(song => song.set !== 'Maybe').length;
                                %>
                                <span class="song-count"><%= numberedSongCount %> songs</span>
                                <% if (totalTime > 0) { %>
                                    <span class="total-time"><%= Math.floor(totalTime / 60) %>:<%= (totalTime % 60).toString().padStart(2, '0') %></span>
                                <% } %>
                            </div>
                        </div>
                        
                        <% if (maybeTime > 0) { %>
                            <div class="maybe-summary-card mt-3">
                                <div class="maybe-summary-header">
                                    <strong>Maybe Set</strong>
                                </div>
                                <div class="maybe-summary-stats">
                                    <% 
                                    const maybeSongCount = audioSongs.filter(song => song.set === 'Maybe').length;
                                    %>
                                    <span class="song-count"><%= maybeSongCount %> songs</span>
                                    <span class="maybe-time"><%= Math.floor(maybeTime / 60) %>:<%= (maybeTime % 60).toString().padStart(2, '0') %></span>
                                </div>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="bi bi-info-circle text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">No audio files to summarize</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .audio-player {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .player-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .control-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .control-btn:hover {
        background: #0056b3;
    }
    
    .control-btn:active {
        background: #004085;
    }
    
    .control-btn i {
        font-size: large;
    }
    
    .bold-icon {
        -webkit-text-stroke: .3px white;
    }
    
    .playlist {
        padding: 0;
        margin: 0;
        list-style: none;
    }
    
    .playlist li {
        padding: 10px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .playlist li:hover {
        background-color: #f8f9fa;
    }
    
    .playlist li.active {
        background-color: #007bff !important;
        color: white;
    }
    
    .playlist li.active a {
        color: white;
    }
    
    .playlist li.active .song-title {
        color: white;
        font-weight: bold;
    }
    
    .playlist li.active .song-details {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .playlist li.active .set-label {
        background: #ffffff;
        color: #007bff;
    }
    
    .playlist li:nth-child(odd) {
        background-color: #f8f9fa;
    }
    
    .playlist li:nth-child(even) {
        background-color: white;
    }
    
    .playlist li a {
        color: #333;
        text-decoration: none;
        display: block;
    }
    
    .song-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .song-title {
        font-weight: bold;
    }
    
    .song-details {
        font-size: 14px;
        opacity: 0.7;
    }
    
    .set-label {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .set-summary-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
    }
    
    .set-summary-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .set-summary-header {
        color: #495057;
        font-size: 1.1em;
        margin-bottom: 10px;
        border-bottom: 2px solid #28a745;
        padding-bottom: 5px;
    }
    
    .set-summary-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
    }
    
    .song-count {
        color: #6c757d;
        font-weight: 500;
    }
    
    .set-time {
        color: #28a745;
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .total-summary-card {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.2s ease;
    }
    
    .total-summary-card:hover {
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        transform: translateY(-1px);
    }
    
    .total-summary-header {
        color: #1976d2;
        font-size: 1.2em;
        margin-bottom: 15px;
        border-bottom: 2px solid #2196f3;
        padding-bottom: 8px;
    }
    
    .total-summary-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1em;
    }
    
    .total-time {
        color: #1976d2;
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .maybe-summary-card {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
    }
    
    .maybe-summary-card:hover {
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        transform: translateY(-1px);
    }
    
    .maybe-summary-header {
        color: #856404;
        font-size: 1.1em;
        margin-bottom: 10px;
        border-bottom: 2px solid #ffc107;
        padding-bottom: 5px;
    }
    
    .maybe-summary-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
    }
    
    .maybe-time {
        color: #856404;
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .no-audio {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
</style>

<script>
    let currentSong = 0;
    const audio = document.getElementById('audio');
    const playlist = document.getElementById('playlist');
    const tracks = playlist ? playlist.querySelectorAll('li') : [];

    if (audio && tracks.length > 0) {
        // Set initial volume
        audio.volume = 0.5;

        // Auto-play the first song when page loads
        const firstTrack = tracks[0];
        if (firstTrack) {
            const songUrl = firstTrack.dataset.url;
            if (songUrl) {
                audio.src = songUrl;
                audio.load();
                
                // Try to auto-play with fallback handling
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('Auto-play started successfully');
                        })
                        .catch(error => {
                            console.log('Auto-play blocked, user must click play:', error);
                            // Show a subtle hint that user needs to click play
                            const playButton = audio.querySelector('button[title="Play"]') || 
                                             audio.querySelector('.play-button');
                            if (playButton) {
                                playButton.style.animation = 'pulse 2s infinite';
                            }
                        });
                }
            }
        }

        // Auto-play next song when current one ends
        audio.addEventListener('ended', function() {
            currentSong++;
            if (currentSong >= tracks.length) {
                currentSong = 0; // Loop back to first song
            }
            playSong(tracks[currentSong]);
        });
    }

    function playSong(songElement, event) {
        if (event) {
            event.preventDefault();
        }
        
        if (!songElement || !audio) return;

        // Update active state
        document.querySelectorAll('#playlist li').forEach(li => li.classList.remove('active'));
        songElement.classList.add('active');

        // Get song URL and play
        const songUrl = songElement.dataset.url;
        if (songUrl) {
            audio.src = songUrl;
            audio.load();
            audio.play();
            
            // Update current song index
            currentSong = Array.from(tracks).indexOf(songElement);
        }
    }
    
    function restartCurrentSong() {
        if (audio) {
            audio.currentTime = 0;
            audio.play();
        }
    }
    
    function playNextSong() {
        if (tracks.length === 0) return;
        
        currentSong++;
        if (currentSong >= tracks.length) {
            currentSong = 0; // Loop back to first song
        }
        playSong(tracks[currentSong]);
    }
    
    function playPreviousSong() {
        if (tracks.length === 0) return;
        
        currentSong--;
        if (currentSong < 0) {
            currentSong = tracks.length - 1; // Loop to last song
        }
        playSong(tracks[currentSong]);
    }
</script>
